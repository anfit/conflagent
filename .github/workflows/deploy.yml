name: Deploy to Server

on:
  push:
    branches:
      - main
      - staging
      - prod
  pull_request:
  workflow_dispatch:
    inputs:
      run_integration:
        description: 'Set to true to force integration tests on this branch'
        required: false
        default: 'false'
  schedule:
    - cron: '0 2 * * *'

jobs:
  tests:
    name: Run test suite
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run unit tests
        run: |
          pytest -m "not integration"

  integration-tests:
    name: Run integration tests against dev
    runs-on: ubuntu-latest
    needs: tests
    if: |
      github.event_name != 'pull_request' &&
      (
        github.ref_name == 'main' ||
        github.ref_name == 'staging' ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.run_integration == 'true')
      )

    env:
      CONFLAGENT_DEV_URL: ${{ secrets.CONFLAGENT_DEV_URL }}
      CONFLAGENT_DEV_ENDPOINT: ${{ secrets.CONFLAGENT_DEV_ENDPOINT }}
      CONFLAGENT_DEV_TOKEN: ${{ secrets.CONFLAGENT_DEV_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure GitHub CLI is installed
        run: |
          if ! command -v gh >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y gh
          fi

      - name: Check for commits since last completed run
        id: commit-check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          CURRENT_SHA=$(git rev-parse HEAD)
          LAST_COMPLETED_SHA=$(gh run list \
            --workflow "$GITHUB_WORKFLOW" \
            --branch "$GITHUB_REF_NAME" \
            --status completed \
            --json headSha \
            -q '.[0].headSha' || true)

          echo "Current SHA: $CURRENT_SHA"
          if [ -n "$LAST_COMPLETED_SHA" ]; then
            echo "Last completed run SHA: $LAST_COMPLETED_SHA"
          else
            echo "No completed runs found for workflow ${GITHUB_WORKFLOW} on branch ${GITHUB_REF_NAME}."
          fi

          if [ -n "$LAST_COMPLETED_SHA" ] && [ "$CURRENT_SHA" = "$LAST_COMPLETED_SHA" ]; then
            echo "no_changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "no_changes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip integration tests when no new commits
        if: github.event_name == 'schedule' && steps.commit-check.outputs.no_changes == 'true'
        run: |
          echo "No new commits since last nightly run, skipping integration tests"
          exit 0

      - name: Set up Python
        if: github.event_name != 'schedule' || steps.commit-check.outputs.no_changes != 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        if: github.event_name != 'schedule' || steps.commit-check.outputs.no_changes != 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run integration suite
        if: github.event_name != 'schedule' || steps.commit-check.outputs.no_changes != 'true'
        run: |
          pytest -m integration -v

  deploy:
    name: Deploy application
    runs-on: ubuntu-latest
    needs:
      - tests
      - integration-tests
    if: |
      github.event_name != 'pull_request' &&
      (needs.integration-tests.result == 'success' || needs.integration-tests.result == 'skipped') &&
      (github.ref_name == 'main' || github.ref_name == 'staging' || github.ref_name == 'prod')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}

      - name: Determine deployment target
        id: env
        run: |
          BRANCH="${GITHUB_REF##*/}"
          case "$BRANCH" in
            main)
              ENV_NAME="dev"
              ;;
            staging)
              ENV_NAME="stage"
              ;;
            prod)
              ENV_NAME="production"
              ;;
            *)
              echo "‚ùå Unknown branch: $BRANCH"
              exit 1
              ;;
          esac
          echo "env=${ENV_NAME}" >> $GITHUB_OUTPUT
          echo "‚úÖ Will deploy branch '$BRANCH' ‚Üí environment '$ENV_NAME'"

      - name: Add known host
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_HOST }} ssh-ed25519 ${{ secrets.DEPLOY_SSH_PUBLIC_KEY }}" >> ~/.ssh/known_hosts

      - name: Sync repository to server
        run: |
          echo "üì§ Syncing to ${{ steps.env.outputs.env }} environment..."
          rsync -az --delete \
            --exclude '*.md' \
            --exclude '*.example' \
            --exclude '.git' \
            --exclude '.github' \
            --exclude '.gitignore' \
            --exclude '.idea' \
            --exclude 'tests' \
            --exclude 'pytest.ini' \
            ./ \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/home/${{ secrets.DEPLOY_USER }}/deployments/${{ steps.env.outputs.env }}/current/

      - name: Install Python dependencies on server
        run: |
          echo "üì¶ Installing dependencies in venv for ${{ steps.env.outputs.env }} ..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "\
            source /home/${{ secrets.DEPLOY_USER }}/deployments/${{ steps.env.outputs.env }}/venv/bin/activate && \
            pip install -r /home/${{ secrets.DEPLOY_USER }}/deployments/${{ steps.env.outputs.env }}/current/requirements.txt"

      - name: Restart remote service
        run: |
          echo "‚ôªÔ∏è Restarting remote service..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "~/restart-env.sh ${{ steps.env.outputs.env }}"

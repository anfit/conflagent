name: Deploy to Server

on:
  push:
    branches:
      - main
      - staging
      - prod
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment (manual runs only)'
        required: false
        default: dev
        type: choice
        options:
          - dev
          - stage
          - production

jobs:
  determine-target:
    name: Determine deployment parameters
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      run_integration: ${{ steps.set-env.outputs.run_integration }}
    steps:
      - name: Authorize manual deployment
        if: github.event_name == 'workflow_dispatch'
        env:
          ACTOR: ${{ github.actor }}
          MAINTAINERS: ${{ vars.DEPLOY_MAINTAINERS }}
          REPO_OWNER: ${{ github.repository_owner }}
          TARGET_BRANCH: ${{ github.ref_name }}
          TARGET_ENV: ${{ github.event.inputs.environment }}
        run: |
          python - <<'PY'
          import os
          import sys

          actor = os.environ["ACTOR"].lower()
          maintainers = [m.strip().lower() for m in os.environ.get("MAINTAINERS", "").split(",") if m.strip()]
          repo_owner = os.environ["REPO_OWNER"].lower()
          if not maintainers:
            maintainers = [repo_owner]

          if actor not in maintainers:
            allowed = ", ".join(maintainers)
            print(f"::error::Actor '{actor}' is not authorized to run manual deployments. Allowed maintainers: {allowed}")
            sys.exit(1)

          target_env = (os.environ.get("TARGET_ENV") or "dev").strip().lower()
          if target_env not in {"dev", "stage", "production"}:
            print(f"::error::Unsupported manual deployment environment '{target_env}'.")
            sys.exit(1)

          branch = os.environ["TARGET_BRANCH"]
          required_branch = {
            "dev": "main",
            "stage": "staging",
            "production": "prod",
          }[target_env]

          if branch != required_branch:
            print(
              "::error::Manual {env} deployments must run from the '{required}' branch. Current branch: '{branch}'.".format(
                env=target_env,
                required=required_branch,
                branch=branch,
              )
            )
            sys.exit(1)
          PY

      - id: set-env
        env:
          EVENT_NAME: ${{ github.event_name }}
          REF_NAME: ${{ github.ref_name }}
          MANUAL_ENV: ${{ github.event.inputs.environment }}
        run: |
          branch="$REF_NAME"
          event="$EVENT_NAME"
          manual_env="${MANUAL_ENV,,}"

          if [ "$event" = "workflow_dispatch" ]; then
            env_name="${manual_env:-dev}"

            case "$env_name" in
              dev)
                if [ "$branch" != "main" ]; then
                  echo "::error::Manual dev deployments must run from the 'main' branch."
                  exit 1
                fi
                ;;
              stage)
                if [ "$branch" != "staging" ]; then
                  echo "::error::Manual stage deployments must run from the 'staging' branch."
                  exit 1
                fi
                ;;
              production)
                if [ "$branch" != "prod" ]; then
                  echo "::error::Manual production deployments must run from the 'prod' branch."
                  exit 1
                fi
                ;;
              *)
                echo "::error::Unknown manual environment '$env_name'."
                exit 1
                ;;
            esac
          else
            case "$branch" in
              main)
                env_name="dev"
                ;;
              staging)
                env_name="stage"
                ;;
              prod)
                env_name="production"
                ;;
              *)
                echo "::error::Deployments are only permitted from main, staging, or prod."
                exit 1
                ;;
            esac
          fi

          run_integration="false"
          if [ "$env_name" = "stage" ] || [ "$env_name" = "production" ]; then
            run_integration="true"
          fi

          echo "environment=$env_name" >> "$GITHUB_OUTPUT"
          echo "run_integration=$run_integration" >> "$GITHUB_OUTPUT"

  run-unit-tests:
    needs: determine-target
    uses: ./.github/workflows/unit-tests.yml

  run-integration-tests:
    needs: determine-target
    if: needs.determine-target.outputs.run_integration == 'true'
    uses: ./.github/workflows/integration-tests.yml
    secrets: inherit

  deploy:
    name: Deploy application
    needs:
      - determine-target
      - run-unit-tests
      - run-integration-tests
    runs-on: ubuntu-latest
    if: >-
      needs.determine-target.result == 'success' &&
      needs.run-unit-tests.result == 'success' &&
      (
        needs.determine-target.outputs.run_integration != 'true' ||
        needs.run-integration-tests.result == 'success'
      )
    environment:
      name: ${{ needs.determine-target.outputs.environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}

      - name: Announce deployment target
        run: |
          echo "‚úÖ Will deploy branch '${GITHUB_REF_NAME}' ‚Üí environment '${{ needs.determine-target.outputs.environment }}'"

      - name: Add known host
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_HOST }} ssh-ed25519 ${{ secrets.DEPLOY_SSH_PUBLIC_KEY }}" >> ~/.ssh/known_hosts

      - name: Sync repository to server
        env:
          TARGET_ENV: ${{ needs.determine-target.outputs.environment }}
        run: |
          echo "üì§ Syncing to ${TARGET_ENV} environment..."
          rsync -az --delete \
            --exclude '*.md' \
            --exclude '*.example' \
            --exclude '.git' \
            --exclude '.github' \
            --exclude '.gitignore' \
            --exclude '.idea' \
            --exclude 'tests' \
            --exclude 'pytest.ini' \
            ./ \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/home/${{ secrets.DEPLOY_USER }}/deployments/${TARGET_ENV}/current/

      - name: Install Python dependencies on server
        env:
          TARGET_ENV: ${{ needs.determine-target.outputs.environment }}
        run: |
          echo "üì¶ Installing dependencies in venv for ${TARGET_ENV} ..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "\
            source /home/${{ secrets.DEPLOY_USER }}/deployments/${TARGET_ENV}/venv/bin/activate && \
            pip install -r /home/${{ secrets.DEPLOY_USER }}/deployments/${TARGET_ENV}/current/requirements.txt"

      - name: Restart remote service
        env:
          TARGET_ENV: ${{ needs.determine-target.outputs.environment }}
        run: |
          echo "‚ôªÔ∏è Restarting remote service..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "~/restart-env.sh ${TARGET_ENV}"
